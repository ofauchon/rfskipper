<!DOCTYPE html>
<html>

<head>
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="./svg-pan-zoom.js"></script>
    <script src="./signal.js"></script>
    <script src="./sampledecoders.js"></script>

</head>

<body">

    <p align=center>
        <h2 align=center>RFSkipper Pulses Display</h2>

        <div id="div1"
            style="width:100%;height:300px;border-width:1px;border-style:dotted;border-color:black;overflow-x: auto; overflow-y: hidden; ">
            <svg id="svg_root" xmlns="http://www.w3.org/2000/svg" version="1.1"
                style="width:100%;height:300px;background-color:white">
            <g id="svg_maingroup"></g></svg>
        </div>
        Trace<br>

        <textarea id="text1" style="width:100%;height:100px;font-size: 10px">(Copy RFSkipper traces here to visualize)</textarea><br>
        Console</br>
        <textarea id="console1"
            style="width:100%;height:100px;border:1px solid;font-size: 10px">Console logs: \n</textarea><br>

            <button type="button" onclick="demoTraces()">Fill Demo Traces</button>
            <button type="button" onclick="clickGenerate(false)">Draw</button>
            <button type="button" onclick="clickGenerate(true)">Draw (overlay)</button>


    </p>


    <script>

        var xfactor;

        var demo_traces=`
// TFA
20;03;DEBUG;Pulses=75;Pulses(uSec)=460,3840,490,1990,500,1960,490,4010,470,3910,490,1970,490,3840,490,4010,460,3870,460,1950,490,1990,490,2040,470,1970,490,1970,490,3840,490,2040,490,1970,490,1990,490,1970,490,1970,470,3910,490,3840,490,3830,490,3940,460,3840,470,3860,470,3860,460,2020,490,1950,490,1960,500,1890,490,2040,490,1970,490,1950,460,1950,490,2020,480,1030,610;
//20;04;DEBUG;Pulses=33;Pulses(uSec)=460,3920,480,3840,490,3910,470,3910,490,3840,490,3840,460,2050,460,1950,490,1940,470,1940,500,2060,470,1940,490,2000,490,1890,470,2070,450,1010,590;
//20;05;DEBUG;Pulses=57;Pulses(uSec)=490,1890,470,1990,490,2050,460,1970,490,1970,490,3840,490,2040,490,1970,490,1990,500,1890,470,2060,470,3910,490,3840,490,3830,500,3980,490,3880,470,3910,490,3840,490,2040,470,1970,490,1890,470,1990,490,2050,460,1970,490,1970,490,1900,490,2040,480,1040,580;
//20;06;DEBUG;Pulses=45;Pulses(uSec)=490,2040,470,1970,490,1970,490,1890,500,2040,460,3840,470,3930,490,3840,490,3910,470,3910,490,3830,500,3830,490,2040,490,1970,490,2000,490,1970,490,1970,460,1950,490,1990,490,1970,490,1970,460,1150,580;
//20;07;DEBUG;Pulses=51;Pulses(uSec)=490,1920,490,1970,490,3860,470,2060,470,1940,500,1990,490,1890,470,2070,460,3860,470,3910,490,3840,490,3910,470,3860,460,3910,500,3830,490,2040,470,1970,490,1890,470,2000,490,2040,460,1970,490,1900,470,1990,490,2040,480,1040,590;
//20;08;DEBUG;Pulses=47;Pulses(uSec)=470,3930,490,1970,470,1920,490,1970,490,1940,470,2020,490,3880,490,3840,490,3840,490,3910,490,3930,490,3840,500,3830,490,2040,470,1970,490,1900,460,1990,500,2040,460,1970,490,1900,470,1990,490,2040,480,1030,600;
//20;09;DEBUG;Pulses=51;Pulses(uSec)=470,1950,490,1940,470,3910,490,1970,490,1920,490,1970,490,1940,470,2020,490,3880,490,3840,490,3840,490,3910,490,3890,490,3880,490,3840,490,2040,470,1970,490,1970,490,1890,500,2040,460,1970,490,1970,490,1900,490,2040,480,540,490;
//20;FD;DEBUG;Pulses=301;Pulses(uSec)=210,210,210,200,220,200,210,210,210,200,220,200,210,210,210,200,210,410,630,630,210,200,210,210,420,410,210,200,420,420,210,210,210,200,210,210,210,200,210,210,210,200,210,210,420,410,220,200,210,210,210,200,210,210,420,200,210,210,210,410,210,210,210,210,210,200,210,210,210,200,210,210,420,200,220,410,210,210,410,210,210,200,210,210,210,200,220,410,420,210,210,410,420,200,210,420,410,420,210,210,420,200,210,210,210,410,210,200,420,420,210,210,210,200,420,410,210,210,210,200,420,420,210,200,220,200,420,200,220,410,210,200,420,210,210,410,420,210,210,410,420,410,210,210,420,410,420,210,210,200,210,420,210,200,210,210,210,200,210,210,210,210,210,200,220,200,210,200,220,200,420,410,220,200,210,210,210,200,220,200,210,200,220,200,210,210,210,200,210,210,210,210,210,200,210,210,210,200,210,210,210,200,220,200,210,210,210,210,210,200,210,210,210,200,210,210,210,200,220,200,210,210,210,200,220,200,210,210,210,200,210,210,210,200,210,210,420,210,210,410,210,210,410,420,210,200,210,210,210,210,210,200,210,210,210,200,220,200,210,210,210,200,210,210,210,210,200,210,210,210,210,200,220,200,420,410,210,210,210,200,420,420,420,410,210,200,210,210,420,410,210,210,420,200,220,200,210,200,220,200,210;
//20;17B;DEBUG;Pulses=299;Pulses(uSec)=210,210,210,210,200,210,210,210,210,200,210,210,210,200,220,200,210,420,620,620,220,200,210,210,410,420,210,210,410,420,210,200,210,210,210,200,220,200,210,210,210,210,200,210,420,410,210,210,210,200,220,200,210,210,420,200,210,210,210,410,210,210,210,200,210,210,210,210,210,200,210,210,210,200,420,420,210,200,420,210,210,200,210,210,210,210,200,420,420,200,210,420,420,200,210,420,410,420,210,200,420,210,210,210,210,410,210,210,410,420,210,200,220,200,420,410,210,210,210,200,420,420,410,420,420,410,420,200,220,410,420,200,210,210,210,420,410,210,210,200,220,200,210,210,210,410,210,210,210,200,420,210,210,410,420,410,210,210,210,210,210,200,220,200,210,200,220,200,420,410,210,210,210,210,210,200,210,210,210,200,220,200,210,210,210,200,210,210,210,200,220,200,210,210,210,200,210,210,210,210,200,210,210,210,210,200,210,210,210,210,210,200,210,210,210,200,210,210,210,210,210,200,210,210,210,210,210,200,210,210,210,200,420,420,210,200,210,210,210,210,210,200,210,210,210,200,210,210,210,210,200,210,210,210,210,200,220,200,420,410,210,210,210,200,210,210,210,210,210,200,220,200,420,410,420,210,200,420,210,210,410,420,420,200,210,420,210,200,210,210,210,200,430,410,210,200,210,210,80;
//20;188;DEBUG;Pulses=301;Pulses(uSec)=210,210,210,200,210,210,210,200,220,200,210,210,210,210,210,200,210,410,630,620,210,210,210,210,420,410,210,200,420,410,220,200,220,200,210,210,210,200,210,210,210,200,210,210,420,410,210,210,210,200,220,200,210,210,420,200,210,210,210,410,210,200,220,200,210,210,210,210,210,200,210,210,420,200,210,420,210,200,420,210,210,200,210,210,210,200,210,420,420,200,210,420,420,200,210,410,420,420,210,200,420,210,210,210,210,410,210,200,420,420,210,200,210,210,420,410,210,210,210,200,420,410,220,200,210,210,420,200,210,420,210,200,420,210,210,410,420,210,210,410,420,410,210,210,420,410,420,200,220,200,210,420,210,200,210,210,210,200,210,210,210,210,210,200,210,210,210,200,210,210,420,410,210,210,210,200,220,200,210,210,210,200,220,200,210,200,220,200,210,210,210,200,220,200,210,210,210,200,210,210,210,200,220,200,210,210,210,200,210,210,210,200,220,200,210,210,210,200,210,210,210,200,220,200,210,210,210,210,210,200,210,210,210,200,210,210,420,200,210,420,210,200,420,420,210,200,210,210,210,200,210,210,210,210,210,200,210,210,210,200,220,200,210,210,210,200,210,210,210,210,210,200,210,210,420,410,210,210,210,200,420,410,420,420,210,200,210,210,420,410,210,210,420,200,210,210,210,200,220,200,210;"
`

var colors=['darkblue', 'saddlebrown', 'teal', 'mediumvioletred', 'darkgreen', 'indigo', 'dimgray']





function demoTraces(){
            document.getElementById('text1').value = demo_traces;
       }



        /*
        * This ons logs on html console
        */
        function console1(pLog) {
            document.getElementById('console1').value = document.getElementById('console1').value + pLog + "\n";
        }


        function getRandomColor() {
            var letters = '0123456789ABCDEF';
            var color = '#';
            for (var i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
                return color;
            }
        }

        /*
        *  Draw the signal from pulses 
        */
        function drawPulse(pPulses, pIndex, pOffset) {
            console1("*** DrawPulse ("+pPulses.length + ") index:" + pIndex + " offset:" + pOffset)

            sHeight = 150
            sWidth = 5000

            var totalDuration = 0, totalWidth = 0, posX = 0, newH = 0, oldH = 0;

            // Get the svg root
            var svgmaingroup = document.getElementById("svg_maingroup")
            if (svgmaingroup == null ) alert("Can't find 'svg/maingroup' root tag !")
            
            var subsvg= document.getElementById("subsvg" + pIndex)
            if (subsvg == null ){
                console1("No subsvg"+pIndex+" , creating it")
                var subsvg = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                subsvg.setAttribute("id", "subsvg"+pIndex);
                svgmaingroup.appendChild(subsvg);
            } else {
                subsvg.innerHTML = '';
            }

            // svgroot.innerHTML = '';
            // Resize the svg to 100% of 
            // Get total trace duration
            var totalDuration = 0;
            for (i = 0; i < pPulses.length; i++) {
                totalDuration += pPulses[i];
            }
            xfactor = sWidth / totalDuration ;

            yfactor=1

            oldH = sHeight * yfactor * 0.8;
            // Iterate the pulse array and draw lines in SVG
            for (i = 0; i < pPulses.length; i++) {


                if (i % 2) {
                    newH = sHeight * yfactor * 0.8;
                } else {
                    newH = sHeight * yfactor * 0.2;
                }

                wi = pPulses[i]
                totalWidth += wi;

                var newLineH = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                newLineH.setAttribute('x1', posX * xfactor);
                newLineH.setAttribute('y1', newH + pOffset);
                newLineH.setAttribute('x2', (posX + wi) * xfactor);
                newLineH.setAttribute('y2', newH + pOffset);
                newLineH.setAttribute("stroke", colors[pIndex]);
                subsvg.appendChild(newLineH);

                var newText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                newText.setAttribute('x', posX * xfactor);
                newText.setAttribute('y', newH + pOffset);
                newText.setAttribute('fill', colors[pIndex]);
                newText.setAttribute('font-size', "6px");
                newText.textContent = i + ":" + wi;
                subsvg.appendChild(newText);

                posX += wi;

                var newLineV = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                newLineV.setAttribute('x1', posX * xfactor);
                newLineV.setAttribute('y1', oldH + pOffset);
                newLineV.setAttribute('x2', posX * xfactor);
                newLineV.setAttribute('y2', newH + pOffset);
                newLineV.setAttribute("stroke", colors[pIndex]);
                subsvg.appendChild(newLineV);
                oldH = newH;

            }

            // Installing ZoomTiger SVG 
            window.zoomTiger = svgPanZoom('#svg_root', {
                zoomEnabled: true,
                controlIconsEnabled: true,
                });


        }
        /* Set marks on the trace */
        function mark(pIndex, pStart, pEnd, pColor, pMsg) {
            var subsvg= document.getElementById("subsvg" + pIndex)
            var newLineH = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                newLineH.setAttribute('x1', pStart );
                newLineH.setAttribute('y1', 50 * pIndex);
                newLineH.setAttribute('x2', pEnd );
                newLineH.setAttribute('y2', 50*pIndex);
                newLineH.setAttribute("stroke", pColor);
                //newLineH.setAttribute('stroke-width=',3)
                subsvg.appendChild(newLineH);

        }

/*
        function decodeProtocol(pPulses) {

            var pos = 0;
            var out = pulsesToBytes(pPulses, 210, 30);
            return (out)
        }
*/




        /* -------------------------------------------------------------------------------- */

        function clickGenerate(pIsOverlay) {


            // Clear console
            document.getElementById('console1').value = "";

            // List available sample decoders
            console1("Available sample decoders:")
            sampledecoders.forEach(s => console1("      "+s))

            // Parse textarea input and decode pulses trace
            var traces = []
            var lines = document.getElementById('text1').value.split('\n'); // process every lines of textarea
            for(var i = 0;i < lines.length;i++){
                var line = lines[i]
                if (line.startsWith("20")){
                    var t= Signal.debugToTrace(line)
                    if (t != null ) {
                        traces.push(t)
                    }
                }
            }
            
            // Offset Mode
            offset =0; 
            if (pIsOverlay==true){
                offset=100
            }

            // Draw the trace
            for (var k=0; k<traces.length; k++){
                console1("NFO: Drawing trace " + k +"/" + traces.length)
                drawPulse(traces[k], k, offset*k);
            }


            // Decode it 
            decode_tfa(traces[0])



 

        }




    </script>

</body>

</html>